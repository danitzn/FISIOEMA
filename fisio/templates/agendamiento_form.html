{% extends 'base_administrativo.html' %}
{% load static %}

{% block content %}
<h2 class="mb-4">Agendar Turno</h2>

<form method="post" class="bg-white p-4 rounded-lg shadow-md">
    {% csrf_token %}
    
    <div class="row g-3">
        <div class="col-md-6">
            <label for="id_profesional" class="form-label">Profesional</label>
            {{ form.profesional }}
            {% if form.profesional.errors %}
                <div class="text-danger small">{{ form.profesional.errors|join:" " }}</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            <label for="id_paciente" class="form-label">Paciente</label>
            {{ form.paciente }}
            {% if form.paciente.errors %}
                <div class="text-danger small">{{ form.paciente.errors|join:" " }}</div>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-md-6">
            <label for="id_servicio" class="form-label">Servicio</label>
            {{ form.servicio}}
            {% if form.servicio.errors %}
                <div class="text-danger small">{{ form.servicio.errors|join:" " }}</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            <label for="id_fecha" class="form-label">Fecha</label>
            {{ form.fecha }}
            {% if form.fecha.errors %}
                <div class="text-danger small">{{ form.fecha.errors|join:" " }}</div>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-md-6">
            <label for="id_hora" class="form-label">Hora</label>
            {{ form.hora }}
            {% if form.hora.errors %}
                <div class="text-danger small">{{ form.hora.errors|join:" " }}</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            <label for="id_tipo" class="form-label">Tipo</label>
            {{ form.tipo }}
            {% if form.tipo.errors %}
                <div class="text-danger small">{{ form.tipo.errors|join:" " }}</div>
            {% endif %}
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-md-6">
            <label for="id_referencia_sesion" class="form-label">Referencia Sesi√≥n</label>
            {{ form.referencia_sesion }}
            {% if form.referencia_sesion.errors %}
                <div class="text-danger small">{{ form.referencia_sesion.errors|join:" " }}</div>
            {% endif %}
        </div>
    </div>

    <div class="d-grid gap-2 mt-3">
        <button type="submit" class="btn btn-primary">Agendar</button>
    </div>

    <!-- Mostrar mensajes de error o informativos -->
    {% if messages %}
        <div class="mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const pacienteField = document.getElementById('id_paciente');
        const servicioField = document.getElementById('id_servicio');
        const referenciaSesionField = document.getElementById('id_referencia_sesion');

        async function actualizarSesiones() {
            const paciente = pacienteField.value;
            const servicio = servicioField.value;

            if (paciente && servicio) {
                const response = await fetch(`/obtener_sesiones/?paciente=${paciente}&servicio=${servicio}`);
                const sesiones = await response.json();

                referenciaSesionField.innerHTML = '<option value="">---------</option>';
                sesiones.forEach(sesion => {
                    const option = document.createElement('option');
                    option.value = sesion.id;
                    option.textContent = sesion.nombre;
                    referenciaSesionField.appendChild(option);
                });
            }
        }

        pacienteField.addEventListener('change', actualizarSesiones);
        servicioField.addEventListener('change', actualizarSesiones);
    });
</script>
{% endblock %}
